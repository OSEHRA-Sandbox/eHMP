{
    "//notice": "This file is automatically generated. Any edits will be overwritten.",
    "name": "The running configuration",
    "version": "<%= node['fetch_server']['version'] %>",
    "edition": "<%= node['development'] ? "ONC" : "VIEWER" %>",
    "environment": "<%= node['development'] ? "development" : "production" %>",
    "rootPath": "/resource",
    "corsEnabled": false,
    "externalProtocol": "http",
    "secret": <%= @secure_passcode_list %>,
    "sessionLength": 900000,
    "cookiePrefix": "<%= @cookie_prefix %>",
    "maxSockets": <%= node['fetch_server']['service_config']['max_sockets'] %>,
    "appServer": {
        "port": <%= @port %>
    },
    "writeBackServer": {
        "baseUrl": "http://<%= @write_back_host %>"
    },
    "pickListServer": {
        "baseUrl": "http://<%= @pick_list_host %>"
    },
    "timeoutMillis": 120000,
    "responseTimeoutMillis": 420000,
    "maxListeners": 50,
    "requestTrace": {
        "active": true,
        "logIdParam": "logId",
        "requestIdParam": "requestId"
    },
    "pdpConfig": {
        "ruleFile": "./rules.js"
    },
    "rpcConfig": {
        "context": "HMP UI CONTEXT"
    },
    <% if !@cdsdb.nil? %>
    "cdsMongoServer": {
    "host": "<%= @cdsdb['ipaddress']%>",
    "port": "<%= @cdsdb['mongodb']['config']['port'] %>",
    "username":"<%= @mongodb_creds["user"] %>",
    "password":"<%= @mongodb_creds['password'] %>",
    "options": "ssl=true&authSource=admin&authMechanism=SCRAM-SHA-1",
    "rootCert": "<%= @sslCACertName %>"
    },
    <% end %>
    "cdsInvocationServer": {
    "host": "localhost",
    "port": <%= @cdsinvocation_port %>
    },
    <% if !@crs.nil? %>
    "CRSServer": {
    "host": "<%= @crs['ipaddress'] %>",
    "port": <%= @crs['crs']['fuseki']['port'] %>
    },
    <% end %>
    "vistaSites": {
        <% @vista_sites.each_with_index do |site, index| %>
        "<%= site['vista']['site_id']%>": {
            "division": <%= site['vista']['division'].to_json %>,
            "host": "<%= site['ipaddress']%>",
            "localIP": "IP      ",
            "localAddress": "localhost",
            "port": <%= site['vista']['rpc_port']%>,
            "production": <%= site['vista']['production']%>,
            "accessCode": "<%= site['vista']['access_code']%>",
            "verifyCode": "<%= site['vista']['verify_code']%>",
            "infoButtonOid": "1.3.6.1.4.1.3768",
            "abbreviation": "<%= site['vista']['abbreviation']%>",
            "uatracker": <%= site['vista']['uatracker'].nil? ? "true" : site['vista']['uatracker'] %>
        }<%= ',' unless index == @vista_sites.size - 1 %>
        <% end %>
    },
    "mvi": {
        "baseUrl": "<%= @mvi['mvi']['protocol']%>://<%= @mvi['ipaddress']%>:<%= @mvi['mvi']['port']%>",
        "senderCode": "<%= @mvi['mvi']['sender_code']%>",
        "search": {
            "path": "<%= @mvi['mvi']['search_path']%>"
        },
        "sync": {
            "path": "<%= @mvi['mvi']['sync_path']%>"
        },
        "agentOptions": {
            "key": <%= @mvi['mvi']['agent_options']['key'].nil? ? "null" : "\"#{@mvi['mvi']['agent_options']['key']}\"" %>,
            "cert": <%= @mvi['mvi']['agent_options']['cert'].nil? ? "null" : "\"#{@mvi['mvi']['agent_options']['cert']}\"" %>,
            "rejectUnauthorized": <%= @mvi['mvi']['agent_options']['reject_unauthorized'].nil? ? "null" : "\"#{@mvi['mvi']['agent_options']['reject_unauthorized']}\"" %>,
            "requestCert": <%= @mvi['mvi']['agent_options']['request_cert'].nil? ? "null" : "\"#{@mvi['mvi']['agent_options']['request_cert']}\"" %>,
            "ca": <%= @mvi['mvi']['agent_options']['ca'].nil? ? "null" : @mvi['mvi']['agent_options']['ca'] %>,
            "passphrase": <%= @mvi['mvi']['agent_options']['passphrase'].nil? ? "null" : "\"#{@mvi['mvi']['agent_options']['passphrase']}\"" %>,
            "maxSockets": <%= @mvi['mvi']['agent_options']['max_sockets'].nil? ? "null" : "#{@mvi['mvi']['agent_options']['max_sockets']}" %>
        }
    },
    "vhic": {
        "baseUrl": "<%= @vhic['vhic']['protocol']%>://<%= @vhic['ipaddress']%>:<%= @vhic['vhic']['port']%>",
        "senderCode": "<%= @vhic['vhic']['sender_code']%>",
        "search": {
            "path": "<%= @vhic['vhic']['search_path']%>"
        },
        "sync": {
            "path": "<%= @vhic['vhic']['sync_path']%>"
        },
        "agentOptions": {
            "key": <%= @vhic['vhic']['agent_options']['key'].nil? ? "null" : "\"#{@vhic['vhic']['agent_options']['key']}\"" %>,
            "cert": <%= @vhic['vhic']['agent_options']['cert'].nil? ? "null" : "\"#{@vhic['vhic']['agent_options']['cert']}\"" %>,
            "rejectUnauthorized": <%= @vhic['vhic']['agent_options']['reject_unauthorized'].nil? ? "null" : "\"#{@vhic['vhic']['agent_options']['reject_unauthorized']}\"" %>,
            "requestCert": <%= @vhic['vhic']['agent_options']['request_cert'].nil? ? "null" : "\"#{@vhic['vhic']['agent_options']['request_cert']}\"" %>,
            "ca": <%= @vhic['vhic']['agent_options']['ca'].nil? ? "null" : @vhic['vhic']['agent_options']['ca'] %>,
            "passphrase": <%= @vhic['vhic']['agent_options']['passphrase'].nil? ? "null" : "\"#{@vhic['vhic']['agent_options']['passphrase']}\"" %>,
            "maxSockets": <%= @vhic['vhic']['agent_options']['max_sockets'].nil? ? "null" : "#{@vhic['vhic']['agent_options']['max_sockets']}" %>
        }
    },
    <% if !@vix.nil? %>
    "vix": {
        "baseUrl": "<%= @vix['vix']['protocol']%>://<%= @vix['ipaddress']%>:<%= @vix['vix']['port']%>",
        "api" : {
            "studyQuery" :  "/vix/viewer/studyquery",
            "studyDetails" : "/vix/viewer/studydetails"
        },
        "agentOptions": {
            "pfx": <%= @vix['vix']['agent_options']['pfx'].nil? ? "null" : "\"#{@vix['vix']['agent_options']['pfx']}\"" %>,
            "rejectUnauthorized": <%= @vix['vix']['agent_options']['reject_unauthorized'].nil? ? "null" : "\"#{@vix['vix']['agent_options']['reject_unauthorized']}\"" %>,
            "requestCert": <%= @vix['vix']['agent_options']['request_cert'].nil? ? "null" : "\"#{@vix['vix']['agent_options']['request_cert']}\"" %>,
            "passphrase": <%= @vix['vix']['agent_options']['passphrase'].nil? ? "null" : "\"#{@vix['vix']['agent_options']['passphrase']}\"" %>,
            "maxSockets": <%= @vix['vix']['agent_options']['max_sockets'].nil? ? "null" : "#{@vix['vix']['agent_options']['max_sockets']}" %>
        }
    },
    <% end %>
    "vxSyncServer": {
        "baseUrl": "http://<%= @vxsync_sync_host %>"
    },
    "solrClient": {
        "childInstanceEnabled": <%= @node['fetch_server']['log_level']['solr_client']['child_instance_enabled'] %>,
        "dataTimeoutMillis": <%= @node['solr_client']['data_timeout_millis'] %>,
        "waitLoopDelayMillis": <%= @node['solr_client']['wait_loop_delay_millis'] %>,
        "requeryLoopDelayMillis": <%= @node['solr_client']['requery_loop_delay_millis'] %>,
        "core": "<%= @node['solr_client']['core'] %>",
        "zooKeeperConnection": "<%= @zookeeper['zookeeper']['zookeeper_connection'] %>",
        "path": "<%= @node['solr_client']['path'] %>",
        "nodeEventLogLevel": "<%= @node['fetch_server']['log_level']['solr_client']['node_event'] %>",
        "zookeeperEventLogLevel": "<%= @node['fetch_server']['log_level']['solr_client']['zookeeper_event'] %>",
        "zooKeeperOptions": {
            "retries": <%= @node['solr_client']['zookeeper_options']['retries'] %>
        }
    },
    "asuServer": {
        "baseUrl": "http://<%= @asu_host %>",
        "timeout": <%= @node['fetch_server']['asu']['timeout'] %>
    },
    "jdsServer": {
        "baseUrl": "http://<%= @jds['ipaddress']%>:<%= @jds['jds']['cache_listener_ports']['general']%>",
        "urlLengthLimit": 120
    },
    "generalPurposeJdsServer": {
        "baseUrl": "http://<%= @pjds['ipaddress']%>:<%= @pjds['jds']['cache_listener_ports']['general']%>",
        "urlLengthLimit": 120
    },
    <% if !@oracle.nil? %>
    "oracledb": {
        "activityDatabase": {
            "user": "<%= @oracle_ehmpuser_username %>",
            "password": "<%= @oracle_ehmpuser_password %>",
            "connectString": "<%= @oracle[:ipaddress] %>:<%= @oracle[:ehmp_oracle][:oracle_config][:port] %>/<%= @oracle[:ehmp_oracle][:oracle_sid] %>",
            "poolMin": <%= @node['fetch_server']['oracle_connection_pool']['minimum'] %>,
            "poolMax": <%= @node['fetch_server']['oracle_connection_pool']['maximum'] %>
        },
        "notifsDatabase": {
            "user": "<%= @oracle_ehmpuser_username %>",
            "password": "<%= @oracle_ehmpuser_password %>",
            "connectString": "<%= @oracle[:ipaddress] %>:<%= @oracle[:ehmp_oracle][:oracle_config][:port] %>/<%= @oracle[:ehmp_oracle][:oracle_sid] %>",
            "poolMin": <%= @node['fetch_server']['oracle_connection_pool']['minimum'] %>,
            "poolMax": <%= @node['fetch_server']['oracle_connection_pool']['maximum'] %>
        },
        "communicationsDatabase" : {
            "user": "<%= @oracle_ehmpuser_username %>",
            "password": "<%= @oracle_ehmpuser_password %>",
            "connectString": "<%= @oracle[:ipaddress] %>:<%= @oracle[:ehmp_oracle][:oracle_config][:port] %>/<%= @oracle[:ehmp_oracle][:oracle_sid] %>",
            "poolMin": <%= @node['fetch_server']['oracle_connection_pool']['minimum'] %>,
            "poolMax": <%= @node['fetch_server']['oracle_connection_pool']['maximum'] %>
        },
        "ehmpDatabase" : {
            "user": "<%= @oracle_ehmpuser_username %>",
            "password": "<%= @oracle_ehmpuser_password %>",
            "connectString": "<%= @oracle[:ipaddress] %>:<%= @oracle[:ehmp_oracle][:oracle_config][:port] %>/<%= @oracle[:ehmp_oracle][:oracle_sid] %>",
            "poolMin": <%= @node['fetch_server']['oracle_connection_pool']['minimum'] %>,
            "poolMax": <%= @node['fetch_server']['oracle_connection_pool']['maximum'] %>
        }
    },
    <% end %>
    "jbpm": {
        "baseUrl": "http://<%= @jbpm_host %>",
        "apiPath": "/business-central/rest",
        "adminUser": {
            "username": "<%= @jbpm_admin_username %>",
            "password": "<%= @jbpm_admin_password %>"
        },
        "nurseUser": {
            "username": "<%= @jbpm_nurseuser_username %>",
            "password": "<%= @jbpm_nurseuser_password %>"
        },
        "healthcheckEndpoint": "/deployment"
    },
    "jdsSync": {
        "settings": {
            "waitMillis": <%= @jds_sync_settings['waitMillis'] %>,
            "timeoutMillis": <%= @jds_sync_settings['timeoutMillis'] %>,
            "syncExistsWaitDelayMillis": <%= @jds_sync_settings['syncExistsWaitDelayMillis'] %>
        }
    },
    "resync": {
        "openJobsTimeoutMillis": <%= @resync_settings['openJobsTimeoutMillis'] %>,
        "inProgressTimeoutMillis": <%= @resync_settings['inProgressTimeoutMillis'] %>,
        "inactivityTimeoutMillis": <%= @resync_settings['inactivityTimeoutMillis'] %>,
        "lastSyncMaxIntervalMillis": <%= @resync_settings['lastSyncMaxIntervalMillis'] %>
    },
    "vxSyncComplexNote": {
        "getComplexNote": {
            "timeout": 120000,
            "port": <%= @complex_note_port %>,
            "rejectUnauthorized": false,
            "requestCert": true,
            "agent": false
        }
    },
    "emailTransport": <%= JSON.pretty_generate(node[:fetch_server][:email_transport], :indent => ' ' * 4).lines.map.with_index { |line, n| ' ' * (n > 0 ? 4 : 0) + line }.join %>,
    "incidents": {
        "rootDirectory": "<%= node[:fetch_server][:incidents][:root_directory] %>",
        "notificationEmail": <%= JSON.pretty_generate(node[:fetch_server][:incidents][:notification_email], :indent => ' ' * 4).lines.map.with_index { |line, n| ' ' * (n > 0 ? 8 : 0) + line }.join %>
    },
    "prefetch": {
        "outboundQueryCriteria": {
           "eHX":
              {
                 "classCode": "('34133-9^^2.16.840.1.113883.6.1')",
                 "status": "('urn:ihe:iti:2010:StatusType:DeferredCreation','urn:oasis:names:tc:ebxml-regrep:StatusType:Approved')"
              }
        }
    },
    "loggers": [
        {
            "name": "res-server",
            "streams": [
                {
                    "level": "<%= @node['fetch_server']['log_level']['fetch_server'] %>",
                    "path": "<%= @node['fetch_server']['log_dir']  %>/fetch_server<%= @index == 0 ? '' : "-#{@index}" %>.log"
                }
            ]
        },
        {
            "name": "audit",
            "streams": [
                {
                    "level": "<%= @node['fetch_server']['log_level']['audit']['fetch_server'] %>",
                    "path": "<%= @node['fetch_server']['log_dir']  %>/fetch_server_audit<%= @index == 0 ? '' : "-#{@index}" %>.log"
                }
            ]
        }
    ],
    "interceptors": {
        <% @node['fetch_server']['interceptors'].each_with_index do |interceptor, index| %>
        "<%= interceptor['name']%>": {
            <% interceptor.each_with_index do |(key, value), hash_index| %>
            <% if key == 'name' then next end %>
            "<%= key %>": <%= value %><%= ',' unless hash_index == interceptor.length - 1 %>
            <% end %>
        }<%= ',' unless index == @node['fetch_server']['interceptors'].size - 1 %>
        <% end %>
    },
    "ontologySuggest": {
        "enabled": false,
        "baseUrl": "https://browser-aws-1.ihtsdotools.org",
        "url": "/api/snomed",
        "database": "us-edition",
        "version": "v20160301"
    },
    "UAtracker": {
        "baseUrl": <%= @node[:fetch_server][:xpolog_baseurl].nil? ? "null" : "\"#{@node[:fetch_server][:xpolog_baseurl]}\"" %>,
        "url": <%= @node[:fetch_server][:xpolog_url].nil? ? "null" : "\"#{@node[:fetch_server][:xpolog_url]}\"" %>
    },
    <% if !@app_dynamics.nil? %>
    "appDynamicsProfile": {
        "controllerHostName": "<%= @app_dynamics['app_dynamics']['controller_host_name'] %>",
        "controllerPort": "<%= @app_dynamics['app_dynamics']['controller_port'] %>",
        "accountName": "<%= @app_dynamics['app_dynamics']['agent_account_name'] %>",
        "accountAccessKey": "<%= @app_dynamics['app_dynamics']['agent_account_access_key'] %>",
        "applicationName": "<%= @app_dynamics['app_dynamics']['agent_application_name'] %>",
        "tierName": "<%= @node['fetch_server']['app_dynamics']['agent_tier_name'] %>_<%= node['db_env']['fetch_server_env'].nil? ? 0 : node['db_env']['fetch_server_env']%>",
        "proxyAutolaunchDisabled": "<%= @node['app_dynamics']['proxy']['proxyAutolaunchDisabled'] %>",
        "proxyCtrlDir": "<%= @node['app_dynamics']['proxy']['ctl_dir']%>",
        "noNodeNameSuffix": "<%= @node['app_dynamics']['proxy']['noNodeNameSuffix'] %>"
    },
    <% end %>
    "externalApiDocumentation": [{
        "baseUrl": "http://<%= @jds['ipaddress']%>:<%= @jds['jds']['cache_listener_ports']['general']%>",
        "prefix": "jds",
        "indexUrl": "http://<%= @jds['ipaddress']%>:<%= @jds['jds']['cache_listener_ports']['general']%>/documentation"
    }]<% if !@video_visits.nil? %>,
    "videoVisit" : {
        "vvService": {
            "baseUrl": "<%= @video_visits['video_visits']['resource_host'] %>/video-visit-resources/v1",
            "cert": "<%= @node['fetch_server']['home_dir'] %>/config/vvs_ssl_client_crt_db",
            "key": "<%= @node['fetch_server']['home_dir'] %>/config/vvs_ssl_client_key_db",
            "ca": "<%= @node['fetch_server']['home_dir'] %>/config/vvs_ssl_client_cer_db",
            "passphrase": <%= @video_visits_vvs_ssl_passphrase.nil? ? "null" : "\"#{@video_visits_vvs_ssl_passphrase}\"" %>
        },
        "pvPatientProfileService": {
            "baseUrl": "<%= @video_visits['video_visits']['patient_viewer_patient_profile_service_host'] %>/PatientProfileServices/rest/v1",
            "cert": "<%= @node['fetch_server']['home_dir'] %>/config/pps_ssl_client_crt_db",
            "key": "<%= @node['fetch_server']['home_dir'] %>/config/pps_ssl_client_key_db",
            "ca": "<%= @node['fetch_server']['home_dir'] %>/config/pps_ssl_client_cer_db",
            "passphrase": <%= @video_visits_pps_ssl_passphrase.nil? ? "null" : "\"#{@video_visits_pps_ssl_passphrase}\"" %>
        },
        "sourceSystemName": "ehmp"
    }
    <% end %>
}
