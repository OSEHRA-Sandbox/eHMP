set serveroutput on

--
-- Create JBPM user if it doesn't exist
--
DECLARE
        u_count number;
        user_name VARCHAR2 (50);
        password VARCHAR(32);

    BEGIN
        u_count :=0;
        user_name := '<%= @jbpm_username %>';
        password := '<%= @jbpm_password %>';

        SELECT COUNT (1) INTO u_count FROM dba_users WHERE username = UPPER (user_name);

             IF u_count = 0
             THEN

                EXECUTE IMMEDIATE 'CREATE USER '||user_name||' IDENTIFIED BY '||password||' ';
                EXECUTE IMMEDIATE 'GRANT DBA TO '||user_name||' ';

              END IF;

        EXCEPTION
           WHEN OTHERS
              THEN
                     DBMS_OUTPUT.put_line (SQLERRM);
                     DBMS_OUTPUT.put_line ('   ');

    END;

/

--
-- Create Activitydb user if it doesn't exist
--
DECLARE
        u_count number;
        user_name VARCHAR2 (50);
        password VARCHAR(32);

    BEGIN
        u_count :=0;
        user_name := '<%= @activitydb_username %>';
        password := '<%= @activitydb_password %>';

        SELECT COUNT (1) INTO u_count FROM dba_users WHERE username = UPPER (user_name);

         IF u_count = 0
         THEN
            EXECUTE IMMEDIATE 'CREATE USER '||user_name||' IDENTIFIED BY '||password||' ';
         ELSE
            SELECT COUNT (1) INTO u_count FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE='DBA' AND GRANTEE=UPPER (user_name);
            IF u_count > 0
            THEN
              EXECUTE IMMEDIATE 'REVOKE DBA FROM '||user_name;
            END IF;
         END IF;
         EXECUTE IMMEDIATE 'GRANT CONNECT TO '||user_name||' ';
         EXECUTE IMMEDIATE 'GRANT RESOURCE TO '||user_name||' ';

        EXCEPTION
           WHEN OTHERS
              THEN
                     DBMS_OUTPUT.put_line (SQLERRM);
                     DBMS_OUTPUT.put_line ('   ');

    END;

/

--
-- Create activitydbuser if it doesn't exist
--
DECLARE
    u_count number;
    user_name VARCHAR2 (50);
    password VARCHAR(32);

  BEGIN
    u_count :=0;
    user_name := '<%= @activitydbuser_username %>';
    password := '<%= @activitydbuser_password %>';

    SELECT COUNT (1) INTO u_count FROM dba_users WHERE username = UPPER (user_name);

      IF u_count = 0 THEN
        EXECUTE IMMEDIATE 'CREATE USER '||user_name||' IDENTIFIED BY '||password||' ';
      ELSE
        SELECT COUNT (1) INTO u_count FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE='DBA' AND GRANTEE=UPPER (user_name);
            IF u_count > 0
            THEN
              EXECUTE IMMEDIATE 'REVOKE DBA FROM '||user_name;
            END IF;
      END IF;
      EXECUTE IMMEDIATE 'GRANT CONNECT TO '||user_name||' ';
      EXECUTE IMMEDIATE 'GRANT RESOURCE TO '||user_name||' ';

    EXCEPTION
       WHEN OTHERS
          THEN
                 DBMS_OUTPUT.put_line (SQLERRM);
                 DBMS_OUTPUT.put_line ('   ');
  END;

/

--
-- Create NotifDb user if it doesn't exist
--
DECLARE
        u_count number;
        user_name VARCHAR2 (50);
        password VARCHAR(32);

    BEGIN
        u_count :=0;
        user_name := '<%= @notifdb_password %>';
        password := '<%= @notifdb_password %>';
        SELECT COUNT (1) INTO u_count FROM dba_users WHERE username = UPPER (user_name);

         IF u_count = 0
         THEN
            EXECUTE IMMEDIATE 'CREATE USER '||user_name||' IDENTIFIED BY '||password||' ';
         ELSE
            SELECT COUNT (1) INTO u_count FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE='DBA' AND GRANTEE=UPPER (user_name);
            IF u_count > 0
            THEN
              EXECUTE IMMEDIATE 'REVOKE DBA FROM '||user_name;
            END IF;
         END IF;
         EXECUTE IMMEDIATE 'GRANT CONNECT TO '||user_name||' ';
         EXECUTE IMMEDIATE 'GRANT RESOURCE TO '||user_name||' ';

        EXCEPTION
           WHEN OTHERS
              THEN
                     DBMS_OUTPUT.put_line (SQLERRM);
                     DBMS_OUTPUT.put_line ('   ');

    END;

/

--
-- Create PCMM user if it doesn't exist
--
DECLARE
        u_count NUMBER;
        user_name VARCHAR2 (50);
        password VARCHAR(32);

    BEGIN
        u_count :=0;
        user_name := '<%= @pcmm_username %>';
        password := '<%= @pcmm_password %>';
        SELECT COUNT (1) INTO u_count FROM dba_users WHERE username = UPPER (user_name);

             IF u_count = 0
             THEN
                EXECUTE IMMEDIATE 'CREATE USER '||user_name||' IDENTIFIED BY '||password||' ';
             ELSE
                SELECT COUNT (1) INTO u_count FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE='DBA' AND GRANTEE=UPPER (user_name);
                IF u_count > 0
                THEN
                  EXECUTE IMMEDIATE 'REVOKE DBA FROM '||user_name;
                END IF;
             END IF;
             EXECUTE IMMEDIATE 'GRANT CONNECT TO '||user_name||' ';
             EXECUTE IMMEDIATE 'GRANT RESOURCE TO '||user_name||' ';
             EXECUTE IMMEDIATE 'GRANT CREATE TABLE TO '||user_name||' ';

  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('EXCEPTION CREATING <%= @pcmm_username %> USER '||SQLCODE||SQLERRM);

    END;

/

--
-- Create SDSADM user if it doesn't exist
--
DECLARE
        u_count NUMBER;
        user_name VARCHAR2 (50);
        password VARCHAR(32);

    BEGIN
        u_count :=0;
        user_name := '<%= @sdsadm_username %>';
        password := '<%= @sdsadm_password %>';
        SELECT COUNT (1) INTO u_count FROM dba_users WHERE username = UPPER (user_name);

         IF u_count = 0
         THEN
            EXECUTE IMMEDIATE 'CREATE USER '||user_name||' IDENTIFIED BY '||password||' ';
         ELSE
            SELECT COUNT (1) INTO u_count FROM DBA_ROLE_PRIVS WHERE GRANTED_ROLE='DBA' AND GRANTEE=UPPER (user_name);
            IF u_count > 0
            THEN
              EXECUTE IMMEDIATE 'REVOKE DBA FROM '||user_name;
            END IF;
         END IF;
         EXECUTE IMMEDIATE 'GRANT CONNECT TO '||user_name||' ';
         EXECUTE IMMEDIATE 'GRANT RESOURCE TO '||user_name||' ';

  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('EXCEPTION CREATING <%= @sdsadm_username %> USER '||SQLCODE||SQLERRM);

END;
/
