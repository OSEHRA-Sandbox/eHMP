SET SERVEROUTPUT ON
<% @tablespaces.each do |name, properties| %>
DECLARE
    u_count number;
    tblspace_name VARCHAR2 (50);
    tblspace_file VARCHAR2 (50);
    tblspace_size VARCHAR2 (50);
    tblspace_extent VARCHAR2 (50);
BEGIN

    u_count := 0;
    tblspace_name := '<%= name %>';
    tblspace_file := '<%= node['ehmp_oracle']['oracle_config']['dbf_dir'] %>/<%= properties['file'] %>';
    tblspace_size := '<%= properties['size'] %>';
    tblspace_extent := '<%= properties['extent'] %>';

    SELECT COUNT (1) INTO u_count FROM dba_tablespaces WHERE tablespace_name = tblspace_name;

    IF u_count = 0  THEN
       EXECUTE IMMEDIATE 'CREATE TABLESPACE '||tblspace_name||' datafile '''||tblspace_file||''' SIZE '||tblspace_size||' REUSE '||
                         'AUTOEXTEND ON NEXT '||tblspace_extent||' MAXSIZE UNLIMITED EXTENT MANAGEMENT LOCAL AUTOALLOCATE SEGMENT SPACE MANAGEMENT AUTO';
    END IF;

    EXCEPTION
       WHEN OTHERS THEN
         DBMS_OUTPUT.PUT_LINE('EXCEPTION CREATING TABLESPACE '||tblspace_name||' '||SQLCODE||' '||SQLERRM);
         RAISE;
END;
/
<% end %>
