DECLARE
    user_count number;
    user_name VARCHAR2(50);
    user_password VARCHAR2(50);
BEGIN
    user_count := 0;
    user_name := '<%= @communicationuser_username %>';
    user_password := '<%= @communicationuser_password %>';

    SELECT COUNT(1) INTO user_count FROM dba_users WHERE username = UPPER(user_name);

    IF user_count = 0 THEN
        EXECUTE IMMEDIATE 'CREATE USER '||user_name||' IDENTIFIED BY '||user_password;
    END IF;

    EXECUTE IMMEDIATE 'GRANT CONNECT TO '||user_name;

    EXCEPTION
       WHEN OTHERS
          THEN
                 DBMS_OUTPUT.put_line (SQLERRM);
                 DBMS_OUTPUT.put_line ('   ');
                 RAISE;
END;
/
